------------------------------------------------------------------------
-- TIPOS E DADOS
------------------------------------------------------------------------

N = 4
ids = { 1..N }
datatype produto =  notebook | tablet
valor = { 2, 4 }

------------------------------------------------------------------------
-- CANAIS
------------------------------------------------------------------------

channel vender : produto.valor
channel comprar : ids.produto
channel processar :ids

------------------------------------------------------------------------
-- FUNCOES
------------------------------------------------------------------------

existeComprador(comprador, <>) = false
existeComprador(comprador, < c >^listaCompradores) = 
		if comprador == c then 
			true 
		else 
			existeComprador(comprador, listaCompradores)


verificarLance(comprador, lance, valor) = if lance == valor then true else false 


------------------------------------------------------------------------
-- AGENTE
------------------------------------------------------------------------

AGENTE(agenteId, produto, valor) = 
		vender!produto!valor -> AGENTE(agenteId, produto, valor)
	[]
		comprar!agenteId!produto -> AGENTE(agenteId, produto, valor)


AGENTES = ||| agenteId:ids, p:produto, v:valor @ AGENTE(agenteId, p, v) 

------------------------------------------------------------------------
-- VENDAS
------------------------------------------------------------------------

COMPRA_E_VENDA(produto, valor) = 
		vender?produto?valor -> COMPRA_E_VENDA(produto, valor)
	[]
		comprar?comprador?prod -> if( produto != prod ) then 
								 	COMPRA_E_VENDA(produto, valor)
								  else
								 	processar!comprador -> COMPRA_E_VENDA(produto, valor)


COMPRAS_E_VENDAS = ||| p:produto, v:valor @ COMPRA_E_VENDA(p, v)

------------------------------------------------------------------------
-- LEILAO
------------------------------------------------------------------------

LEILAO(produto, valor, listaCompradores) =    
		processar?comprador -> if existeComprador(comprador, listaCompradores) then 
							LEILAO(produto, valor, listaCompradores) 
						  else
						  	if(length(listaCompradores) == 3) then
								INICIAR_LEILAO(listaCompradores, valor, 0)
							else
								LEILAO(produto, valor, listaCompradores)
		
		
LEILOES = ||| p:produto, v:valor @ LEILAO(p, v, <>)

------------------------------------------------------------------------
-- INICIAR LEILAO
------------------------------------------------------------------------
		
INICIAR_LEILAO(listaCompradores, valor, lance) = 
		if verificarLance(head(listaCompradores), valor, lance+1) then 
			SKIP 
		else 
			INICIAR_LEILAO(tail(listaCompradores) ^ <head(listaCompradores)>, valor, lance)

------------------------------------------------------------------------
-- ASSERTS
------------------------------------------------------------------------ 
SISTEMA = ((AGENTES [|{|vender, comprar|}|] COMPRAS_E_VENDAS) [|{|processar|}|] LEILOES)
assert SISTEMA :[deadlock free] 
assert SISTEMA :[deterministic] 
